# 출결 시스템 API 설계

[← 출결 서비스 개요로 돌아가기](01_attendance_overview.md)

## 개요 및 도입 의의
출결 시스템은 학생의 출결 제출, 교사의 출결 확인 및 관리, 학부모 통지 등의 기능을 RESTful API를 통해 제공합니다. 본 문서는 개발 단계에서 혼동 없이 바로 활용할 수 있도록 각 엔드포인트의 목적, 파라미터, 응답 형식, 에러 및 상태 코드, 인증(소셜/OAuth2 포함), 확장 지점(API 알림 연동)까지 구체적으로 기술합니다.

---

## API 인증 및 권한
- 인증 방식: Bearer JWT (예: Google OAuth2, 카카오 등 소셜 로그인 연동)
- 인증 흐름: 
    1. (클라이언트) 소셜 로그인 → 액세스 토큰(JWT) 획득 
    2. (서버) JWT 유효성 검사 후 API 허용
- 토큰 갱신: 액세스 토큰 만료 시 리프레시 토큰 활용, /auth/refresh 엔드포인트로 갱신

| 상황           | 엔드포인트 예시             | 설명                          |
|:--------------|:--------------------------|:-----------------------------|
| 로그인         | POST /auth/social         | 소셜 로그인 및 토큰 발급        |
| 토큰 갱신      | POST /auth/refresh        | 리프레시 토큰 전달, JWT 갱신    |

---

## 출결 API 명세 요약표

| 기능            | 메서드/엔드포인트           | 인증 | 주요 역할         | 비고           |
|:----------------|:-------------------------|:-----|:------------------|:--------------|
| 출결코드 요청    | POST /attendance/code     | O    | 오늘 출결 코드 발급 | 교사용         |
| 출결 제출        | POST /attendance/submit   | O    | 학생 출결 제출      |                |
| 출결 확인        | GET /attendance/status    | O    | 본인 출결 조회      | 학생/교사 공통  |
| 출결 전체현황    | GET /attendance/list      | O    | 반 전체 출결 목록   | 교사 대시보드   |
| 출결코드 검증    | POST /attendance/validate | O    | 코드 유효성 확인    |                |
| 알림 전송        | POST /attendance/notify   | O    | 학부모 출결 알림     | 교사용, 확장가능|

---

## 상세 API 엔드포인트 명세

### 1. 출결 코드 발급 (교사용)
- URL: `POST /attendance/code`
- 설명: 당일 수업용 출결코드 신규 발급
- 요청 파라미터:
  | 필드명     | 타입   | 필수 | 설명               | 제약             |
  |:-----------|:-------|:----|:-------------------|:----------------|
  | classId    | string | Y   | 대상 반(클래스) ID  | 24자 ObjectID   |
  | date       | string | N   | 지정 일자(YYYY-MM-DD)| 미입력 시 today |
- 응답 예시:
  ```json
  { "code": "K8F9Z4", "expireAt": "2025-07-09T16:00:00+09:00" }
  ```
- 상태 코드: 200(성공), 401(인증 실패), 403(권한 없음), 422(파라미터 에러)

### 2. 출결 제출 (학생용)
- URL: `POST /attendance/submit`
- 설명: 학생이 출결코드로 출석 제출
- 요청 파라미터:
  | 필드명  | 타입   | 필수 | 설명           | 제약            |
  |:--------|:-------|:----|:---------------|:---------------|
  | code    | string | Y   | 출결 코드       | 6글자, 대문자/숫자 |
  | userId  | string | Y   | 학생 사용자 ID │ 24자 ObjectID   |
  | date    | string | N   | 해당 일자       | YYYY-MM-DD      |
- 응답 예시:
  ```json
  { "status": "present", "timestamp": "2025-07-09T15:40:00+09:00" }
  ```
- 상태 코드: 201(성공), 400(형식 오류), 401(인증 없음), 403(이미 처리됨), 404(코드 없음), 422(입력값 불일치)

### 3. 출결 현황 조회
- URL: `GET /attendance/status`
- 설명: 본인 또는 반의 출결 현황
- 파라미터(Query):
  | 필드명   | 타입   | 필수 | 설명        |
  |:---------|:-------|:----|:------------|
  | userId   | string | N   | 지정 학생 ID |
  | classId  | string | N   | 반 ID        |
  | date     | string | N   | 일자         |
- 응답 예시:
  ```json
  { "status": "absent", "checkedAt": null }
  ```
- 상태 코드: 200(조회 성공), 401(인증 없음), 422(파라미터 오류)

### 4. 출결 전체 현황(교사용)
- URL: `GET /attendance/list`
- 설명: 해당 반 및 일자의 전체 출결 현황 목록
- 파라미터(Query):
  | 필드명   | 타입   | 필수 | 설명      |
  |:---------|:-------|:----|:-----------|
  | classId  | string | Y   | 반 ID     |
  | date     | string | N   | 일자      |
- 응답 예시:
  ```json
  [
    { "userId": "5fcab5...", "status": "late", "checkedAt": "2025-07-09T15:45:00+09:00" }
  ]
  ```
- 상태 코드: 200, 401, 422

### 5. 출결 코드 유효성 검증
- URL: `POST /attendance/validate`
- 설명: 입력한 출결코드의 유효성/만료 확인
- 요청 파라미터:
  | 필드명 | 타입   | 필수 | 설명          |
  |:------|:-------|:----|:--------------|
  | code  | string | Y   | 출결 코드      |
- 응답 예시:
  ```json
  { "valid": true, "expireAt": "2025-07-09T16:00:00+09:00" }
  ```
- 상태 코드: 200, 400, 404

### 6. 출결 알림 전송(확장)
- URL: `POST /attendance/notify`
- 설명: 학부모 등에게 출결 상황 알림 발송 (교사용)
- 요청 파라미터:
  | 필드명    | 타입   | 필수 | 설명              |
  |:----------|:-------|:----|:------------------|
  | userIds   | array  | Y   | 알릴 대상 학생 ID 목록 |
  | status    | string | Y   | 출결 상태             |
  | date      | string | Y   | 일자(YYYY-MM-DD)     |
- 응답 예시:
  ```json
  { "notified": ["5fcab5...", "9bc2b6..."], "fail": [] }
  ```
- 상태 코드: 200, 400, 401, 422

---

## 공통 에러/상태 코드

| 코드 | 의미             | 설명                                   |
|:-----|:----------------|:--------------------------------------|
| 200  | OK              | 요청 성공                              |
| 201  | Created         | 정상 등록(예: 출석 제출)               |
| 400  | Bad Request     | 요청 파라미터 입력 오류                |
| 401  | Unauthorized    | 인증 토큰 없음/유효하지 않음           |
| 403  | Forbidden       | 권한 부족/중복 제출                    |
| 404  | Not Found       | 자원 미존재, 코드 오류                 |
| 422  | Unprocessable   | 파라미터 타입/값 등 제약 위반           |


---

## 출결 API 사용 흐름 예시

1. [학생] 앱에서 소셜 로그인 → JWT 획득
2. [교사] 출결 코드 발급 후, 수업 시작 시 학생들에게 코드 전달
3. [학생] 앱에서 코드로 출석 제출 → 서버 검증 및 기록
4. [교사] 대시보드에서 실시간 전체 현황 확인
5. [교사] 필요시 학부모 대상 출결 알림 전송

---

본 API 설계는 시스템 연동 및 확장(알림 기능 등)까지 고려해 작성되었습니다. 문서 추가 개선 요청이 있다면 말씀해주시기 바랍니다.